version: 2

models:
  - name: dim_geography
    description: >
      Geography dimension containing location and regional information for customers.
      Includes standardized fields for country, state, city, and postal codes.
      Also includes an "Unknown" row (key = -1) to handle missing references in fact tables.
    columns:
      - name: geography_id
        description: "Unique identifier for the geography record."
        tests:
          - unique
          - not_null

      - name: city
        description: "Name of the city."
      - name: state_province_name
        description: "Full name of the state or province."
      - name: state_province_code
        description: "Abbreviated code for the state or province."
      - name: postal_code
        description: "Postal or ZIP code for the location."
      - name: customer_country
        description: "Full name of the customerâ€™s country."
      - name: country_region_code
        description: "Two-letter region or country code."
      - name: ip_address_locator
        description: "Geographic locator string derived from IP address (if available)."

  - name: dim_products
    description: >
      Product dimension including historical changes tracked via snapshot.
      Also includes an "Unknown" row (key = -1) to handle missing references in fact tables.
    columns:
      - name: product_id
        description: "Unique identifier for each product."
        tests:
          - unique
          - not_null

  - name: dim_customers
    description: >
      Customer dimension including historical changes tracked via snapshot.
      Also includes an "Unknown" row (key = -1) to handle missing references in fact tables.
    columns:
      - name: customer_id
        description: "Unique identifier for each customer."
        tests:
          - unique
          - not_null
      - name: sk_geography
        description: "Foreign key referencing the geography dimension."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_geographys')
                field: sk_geography

  - name: dim_subproducts
    description: >
      Subproducts dimension including historical changes tracked via snapshot.
      Also includes an "Unknown" row (key = -1) to handle missing references in fact tables.
    columns:
      - name: sk_subproduct
        description: "Unique identifier for each subproduct."
        tests:
          - unique
          - not_null


  - name: dim_date
    description: "Date dimension providing calendar and time attributes for reporting."
    columns:
      - name: date_id
        description: "Primary key for the date dimension."
        tests:
          - unique
          - not_null
      - name: year
        description: "Calendar year."
      - name: quarter
        description: "Calendar quarter."
      - name: month
        description: "Calendar month."
      - name: month_name
        description: "Full name of the month."
      - name: day
        description: "Day of the month."
      - name: day_name
        description: "Full name of the day."
      - name: is_weekend
        description: "Boolean indicating if the date is a weekend."

  
  - name: fact_sales
    description: >
      Base sales fact table containing one record per sale.
      Includes identifiers, dates, and financial measures, with
      no dimension joins applied yet.
    columns:
      - name: sale_id
        description: "Primary key for each sales record."
        tests:
          - not_null
          - unique
      - name: sales_order_number
        description: "Sales order identifier from the source system."
        tests:
          - not_null
      - name: sk_customer
        description: "Foreign key referencing the customer dimension."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_customer')
                field: sk_customer
      - name: sk_product
        description: "Foreign key referencing the product dimension."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_products')
                field: sk_product
      - name: sk_order_date
        description: "Foreign key referencing the order date in dim_date."
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('dim_date')
                field: sk_date
      
      # Derived metrics
      - name: net_sales_amount
        description: >
          Total sales after discounts have been applied.
          Formula: sales_amount - discount_amount.
        tests:
          - not_null

      - name: gross_profit
        description: >
          Difference between total sales and total product cost.
          Formula: sales_amount - total_product_cost.

      - name: profit_margin_pct
        description: >
          Profit as a percentage of total sales.
          Formula: (sales_amount - total_product_cost) / sales_amount * 100.

      - name: tax_pct
        description: >
          Tax as a percentage of total sales.
          Formula: tax_amount / sales_amount * 100.

      - name: total_cost_with_freight_tax
        description: >
          Sum of total product cost, freight cost, and tax amount.
          Formula: total_product_cost + freight_cost + tax_amount.

      - name: revenue_per_unit
        description: >
          Average revenue earned per sold unit.
          Formula: sales_amount / order_quantity.